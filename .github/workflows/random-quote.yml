name: Update Random Quote
on:
  schedule:
    - cron: '0 * * * *'  # Runs at minute 0 of every hour
  workflow_dispatch:      # Allows manual triggers

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load random quote
        id: quote
        run: |
          # Read quotes and count
          mapfile -t QUOTES < <(jq -r '.quotes[] | "\(.text)|\(.author)"' .github/data/quotes.json)
          COUNT=${#QUOTES[@]}
          
          # Select random quote
          INDEX=$(( RANDOM % COUNT ))
          IFS='|' read -r TEXT AUTHOR <<< "${QUOTES[$INDEX]}"
          
          # Escape and output
          echo "text=${TEXT//\"/\\\"}" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Update README
        if: steps.quote.outputs.count > 0
        run: |
          # Generate new content
          CONTENT="<!-- QUOTE_START -->
**\"${{ steps.quote.outputs.text }}\"**  
*- ${{ steps.quote.outputs.author }}*  
ðŸ”„ Updated: $(date +'%Y-%m-%d %H:%M') â€¢ [Manual Refresh](https://github.com/adityapatil343/adityapatil343/actions/workflows/random-quote.yml)
<!-- QUOTE_END -->"

          # Replace section
          awk -v content="$CONTENT" '
            BEGIN {replaced=0}
            /<!-- QUOTE_START -->/ {print content; replaced=1; next}
            /<!-- QUOTE_END -->/ {replaced=0; next}
            !replaced' README.md > tmp.md && mv tmp.md README.md

      - uses: stefanzweifel/git-auto-commit-action@v5
        if: steps.quote.outputs.count > 0
        with:
          commit_message: "ðŸ”„ Updated quote (Auto)"
          committer: "GitHub Actions <action@github.com>"
