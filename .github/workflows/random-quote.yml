name: Daily Quote Update
on:
  schedule:
    - cron: '0 0 * * *'  # Runs at midnight UTC daily
  workflow_dispatch:      # Allows manual triggers

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies
        run: sudo apt-get install -y gettext-base

      - name: Load random quote
        id: quote
        run: |
          QUOTES=($(jq -r '.quotes[] | "\(.text)|\(.author)"' .github/data/quotes.json))
          INDEX=$(( RANDOM % ${#QUOTES[@]} ))
          IFS="|" read -r TEXT AUTHOR <<< "${QUOTES[$INDEX]}"
          echo "text=${TEXT//\"/\\\"}" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          # Create template file
          cat << 'EOF' > template.txt
## üí¨ Daily Inspiration (quotes)
<!-- Dynamic quote section - auto-updates daily -->
**"${QUOTE_TEXT}"**  
*- ${QUOTE_AUTHOR}*  
üîÑ *This quote updates automatically every 24 hours*

<details>
<summary>‚ÑπÔ∏è How these quotes work (expand for more detail)</summary>

üîπ **Auto-rotating**: A new random quote appears daily  
üîπ **Source**: Quotes are pulled from [quotes.json](.github/data/quotes.json)  
üîπ **Update time**: Changes occur around midnight UTC   

</details>
EOF

          # Process template
          export QUOTE_TEXT="${{ steps.quote.outputs.text }}"
          export QUOTE_AUTHOR="${{ steps.quote.outputs.author }}"
          envsubst < template.txt > section.txt

          # Update README
          awk -v new="$(cat section.txt)" '
            BEGIN {p=1; replaced=0}
            /## üí¨ Daily Inspiration \(quotes\)/ {print new; replaced=1; p=0}
            /<\/details>/ {p=1}
            p' README.md > tmp.md && mv tmp.md README.md

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "üîÑ Updated daily quote"
