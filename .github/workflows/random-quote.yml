name: Daily Quote Update
on:
  schedule:
    - cron: '0 0 * * *'  # Midnight UTC daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get random quote
        id: quote
        run: |
          QUOTE=$(jq -r '.quotes[input_line_number] | "\(.text)|\(.author)"' \
            --argjson input_line_number $(( RANDOM % $(jq '.quotes | length' .github/data/quotes.json) )) \
            .github/data/quotes.json)
          IFS='|' read -r TEXT AUTHOR <<< "$QUOTE"
          echo "text=${TEXT}" >> $GITHUB_OUTPUT
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          UPDATED_CONTENT=$'### ğŸ’¬ Daily Inspiration\n\n> **'"${{ steps.quote.outputs.text }}"'**  \n> *â€” '"${{ steps.quote.outputs.author }}"'*\n\n<p align="right">\n  <small>ğŸ”„ Auto-updates daily at midnight UTC</small>\n</p>\n\n<details>\n<summary>â„¹ï¸ How these quotes work</summary>\n\nğŸ”¹ **Auto-rotating**: New random quote daily  \nğŸ”¹ **Source**: <code>quotes.json</code> in this repo  \nğŸ”¹ **Update time**: ~12:00AM UTC  \n\n</details>'

          awk -v content="$UPDATED_CONTENT" '
            BEGIN {replaced=0}
            /### ğŸ’¬ Daily Inspiration/ {print content; replaced=1; next}
            /<\/details>/ {replaced=0; next}
            !replaced
          ' README.md > tmp.md && mv tmp.md README.md

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "âœ¨ Updated daily quote"
