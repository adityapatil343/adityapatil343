name: Daily Quote Update
on:
  schedule:
    - cron: '0 0 * * *'  # Midnight UTC daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get random quote
        id: quote
        run: |
          QUOTE=$(jq -r '.quotes[input_line_number] | "\(.text)|\(.author)"' \
            --argjson input_line_number $(( RANDOM % $(jq '.quotes | length' .github/data/quotes.json) )) \
            .github/data/quotes.json)
          IFS='|' read -r TEXT AUTHOR <<< "$QUOTE"
          echo "text=${TEXT}" >> $GITHUB_OUTPUT
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          UPDATED_CONTENT=$'<div style="border-left: 4px solid #58a6ff; padding: 10px 20px; background: rgba(88,166,255,0.05); border-radius: 8px; margin: 20px 0;">\n\n> '"${{ steps.quote.outputs.text }}"'\n\n<p style="text-align: right; font-style: italic;">â€” '"${{ steps.quote.outputs.author }}"'</p>\n\n</div>\n\n<p align="center" style="color: #586069;">ğŸ”„ Automatically updates daily at midnight UTC</p>\n\n<details>\n<summary>â„¹ï¸ About this feature</summary>\n\nğŸ”¹ **Fresh quote daily**  \nğŸ”¹ **Source**: <code>quotes.json</code> in this repo  \nğŸ”¹ **Total quotes**: '"$(jq '.quotes | length' .github/data/quotes.json)"' available  \n\n</details>'

          awk -v content="$UPDATED_CONTENT" '
            BEGIN {replaced=0}
            /<div style="border-left:/ {print content; replaced=1; next}
            /<\/details>/ {replaced=0; next}
            !replaced
          ' README.md > tmp.md && mv tmp.md README.md

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ¨ Updated quote with new stylish layout"
