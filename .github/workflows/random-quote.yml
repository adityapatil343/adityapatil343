name: Daily Quote Update
on:
  schedule:
    - cron: '0 0 * * *'  # Runs at midnight UTC daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        run: sudo apt-get install -y gettext-base

      - name: Get random quote
        id: quote
        run: |
          mapfile -t QUOTES < <(jq -r '.quotes[] | "\(.text)|\(.author)"' .github/data/quotes.json)
          INDEX=$(( RANDOM % ${#QUOTES[@]} ))
          IFS='|' read -r TEXT AUTHOR <<< "${QUOTES[$INDEX]}"
          echo "text=${TEXT//\"/\\\"}" >> $GITHUB_OUTPUT
          echo "author=${AUTHOR}" >> $GITHUB_OUTPUT

      - name: Update README
        run: |
          # Generate new content
          CONTENT=$'## 💬 Daily Inspiration (quotes)\n<!-- Dynamic quote section - auto-updates daily -->\n**"'"${{ steps.quote.outputs.text }}"'"**\n*- '"${{ steps.quote.outputs.author }}"'*\n🔄 *This quote updates automatically every 24 hours*\n\n<details>\n<summary>ℹ️ How these quotes work (expand for more detail)</summary>\n\n🔹 **Auto-rotating**: A new random quote appears daily\n🔹 **Source**: Quotes are pulled from [quotes.json](.github/data/quotes.json)\n🔹 **Update time**: Changes occur around midnight UTC\n\n</details>'

          # Update README
          awk -v content="$CONTENT" '
            BEGIN {replaced=0}
            /## 💬 Daily Inspiration \(quotes\)/ {print content; replaced=1; next}
            /<\/details>/ {replaced=0; next}
            !replaced
          ' README.md > tmp.md && mv tmp.md README.md

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "🔄 Updated daily quote"
